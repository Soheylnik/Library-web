{% extends 'parent/base.html' %}
{% load static %}

{% block title %}{{ title }} - بوکن{% endblock %}

{% block content %}

<style>
/* بهبود نمایش فیلدهای فرم */
input[type="text"], 
input[type="number"], 
input[type="date"], 
textarea, 
select {
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    color: #495057 !important;
    background-color: white !important;
    font-size: 16px !important;
    font-family: inherit !important;
}

input[type="text"]:focus, 
input[type="number"]:focus, 
input[type="date"]:focus, 
textarea:focus, 
select:focus {
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    outline: none !important;
    color: #495057 !important;
    background-color: white !important;
}

/* اطمینان از نمایش متن در فیلدها */
input[type="text"]::placeholder,
input[type="number"]::placeholder,
textarea::placeholder {
    color: #6c757d !important;
    opacity: 1 !important;
}

/* بهبود نمایش checkbox ها */
input[type="checkbox"] {
    transform: scale(1.2);
    margin-left: 8px;
}

/* بهبود نمایش فیلدهای جدید */
.new-field-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

.new-field-section label {
    color: #6c757d;
    font-size: 13px;
    font-weight: 600;
}

.new-field-section input {
    border: 2px solid #dee2e6 !important;
    background: white !important;
    color: #495057 !important;
}

.new-field-section input:focus {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    color: #495057 !important;
    background: white !important;
}

/* رفع مشکل نمایش متن در فیلدهای Django */
.form-control {
    color: #495057 !important;
    background-color: white !important;
    border: 2px solid #e9ecef !important;
    font-size: 16px !important;
}

.form-control:focus {
    color: #495057 !important;
    background-color: white !important;
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

/* اطمینان از نمایش متن در تمام فیلدها */
input, textarea, select {
    -webkit-text-fill-color: #495057 !important;
    -webkit-opacity: 1 !important;
    opacity: 1 !important;
}
</style>

<script>
// اطمینان از نمایش متن در فیلدها
document.addEventListener('DOMContentLoaded', function() {
    // تنظیم رنگ متن برای تمام فیلدهای ورودی
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(function(input) {
        input.style.color = '#495057';
        input.style.backgroundColor = 'white';
        
        // اطمینان از نمایش متن هنگام تایپ
        input.addEventListener('input', function() {
            this.style.color = '#495057';
            this.style.backgroundColor = 'white';
        });
        
        // اطمینان از نمایش متن هنگام focus
        input.addEventListener('focus', function() {
            this.style.color = '#495057';
            this.style.backgroundColor = 'white';
        });
    });

    // قابلیت انتخاب خودکار ژانر جدید
    const newGenreInput = document.querySelector('input[name="new_genre"]');
    if (newGenreInput) {
        newGenreInput.addEventListener('input', function() {
            const genreValue = this.value.trim();
            if (genreValue) {
                // جستجو برای ژانر مشابه در لیست موجود
                const genreCheckboxes = document.querySelectorAll('input[name="genre"]');
                let foundMatch = false;
                
                genreCheckboxes.forEach(function(checkbox) {
                    const label = checkbox.nextElementSibling;
                    if (label && label.textContent.trim().toLowerCase() === genreValue.toLowerCase()) {
                        checkbox.checked = true;
                        foundMatch = true;
                    }
                });
                
                // اگر ژانر مشابه پیدا نشد، نمایش پیام و اضافه کردن ژانر جدید به لیست
                if (!foundMatch) {
                    showGenreMessage(`ژانر "${genreValue}" جدید خواهد بود و به صورت خودکار انتخاب می‌شود.`);
                    addNewGenreToSelection(genreValue);
                } else {
                    hideGenreMessage();
                    removeNewGenreFromSelection();
                }
            } else {
                hideGenreMessage();
                removeNewGenreFromSelection();
            }
        });
    }

    // اطمینان از اینکه ژانر جدید هنگام ارسال فرم در نظر گرفته شود
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const newGenreInput = document.querySelector('input[name="new_genre"]');
            if (newGenreInput && newGenreInput.value.trim()) {
                // نمایش پیام تأیید
                const confirmMessage = document.createElement('div');
                confirmMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #28a745, #20c997);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                    z-index: 1000;
                    font-weight: 500;
                `;
                confirmMessage.textContent = `ژانر "${newGenreInput.value.trim()}" جدید ایجاد و انتخاب خواهد شد.`;
                document.body.appendChild(confirmMessage);
                
                // حذف پیام بعد از 3 ثانیه
                setTimeout(() => {
                    confirmMessage.remove();
                }, 3000);
            }
        });
    }
});

// تابع نمایش پیام ژانر
function showGenreMessage(message) {
    let messageDiv = document.getElementById('genre-message');
    if (!messageDiv) {
        messageDiv = document.createElement('div');
        messageDiv.id = 'genre-message';
        messageDiv.style.cssText = `
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            color: #155724;
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        `;
        
        // اضافه کردن استایل انیمیشن
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
        
        const genreSection = document.querySelector('input[name="new_genre"]').closest('.new-field-section');
        genreSection.appendChild(messageDiv);
    }
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
}

// تابع مخفی کردن پیام ژانر
function hideGenreMessage() {
    const messageDiv = document.getElementById('genre-message');
    if (messageDiv) {
        messageDiv.style.display = 'none';
    }
}

// تابع اضافه کردن ژانر جدید به لیست انتخاب
function addNewGenreToSelection(genreName) {
    // حذف ژانر قبلی اگر وجود دارد
    removeNewGenreFromSelection();
    
    const genreContainer = document.querySelector('input[name="genre"]').closest('div').parentElement;
    const newGenreDiv = document.createElement('div');
    newGenreDiv.id = 'new-genre-selection';
    newGenreDiv.style.cssText = `
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: linear-gradient(135deg, #e8f5e8, #d4edda);
        border-radius: 6px;
        border: 2px solid #28a745;
        margin-top: 10px;
        animation: slideIn 0.3s ease-out;
    `;
    
    newGenreDiv.innerHTML = `
        <input type="checkbox" checked disabled style="transform: scale(1.2); margin-left: 8px;">
        <label style="margin: 0; cursor: pointer; font-size: 14px; color: #155724; font-weight: 600;">
            ${genreName} (جدید - خودکار انتخاب شده)
        </label>
        <span style="color: #28a745; font-size: 12px; margin-right: auto;">✓</span>
    `;
    
    genreContainer.appendChild(newGenreDiv);
}

// تابع حذف ژانر جدید از لیست انتخاب
function removeNewGenreFromSelection() {
    const newGenreDiv = document.getElementById('new-genre-selection');
    if (newGenreDiv) {
        newGenreDiv.remove();
    }
}
</script>

<h1 style="margin-top: 80px; margin-bottom: 30px; color: #495057; text-align: center; font-size: 2rem; font-weight: bold;">{{ title }}</h1>

<!-- راهنمای استفاده -->
<div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; margin: 20px 0; border-radius: 10px; border-left: 4px solid #2196f3;">
    <h4 style="color: #1976d2; margin: 0 0 10px 0; font-size: 1.1rem;">💡 راهنمای استفاده:</h4>
    <ul style="color: #424242; margin: 0; padding-right: 20px; font-size: 14px;">
        <li>می‌توانید از لیست موجود نویسنده، ناشر و ژانر انتخاب کنید</li>
        <li>یا در صورت عدم وجود، نام جدید را در فیلدهای "جدید" وارد کنید</li>
        <li>فیلدهای ستاره‌دار (*) اجباری هستند</li>
        <li>ژانر اختیاری است - می‌توانید ژانرهای موجود را انتخاب کنید، ژانر جدید اضافه کنید (که خودکار انتخاب می‌شود)، یا هیچ ژانری انتخاب نکنید</li>
        <li>تصاویر باید در فرمت JPG، PNG یا GIF باشند</li>
    </ul>
</div>

<!-- پیام‌ها -->
{% if messages %}
    {% for message in messages %}
        <div style="background: #d4edda; color: #155724; padding: 10px; margin: 10px 0; border-radius: 5px;">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- فرم -->
<form method="POST" enctype="multipart/form-data" style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 5px;">
    {% csrf_token %}
    
    <div style="margin: 20px 0; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.title.label }}</label>
        {{ form.title }}
        {% if form.title.errors %}
            <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                {% for error in form.title.errors %}
                    {{ error }}<br>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <div style="display: flex; gap: 20px; margin: 20px 0;">
        <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.author.label }}</label>
            {{ form.author }}
            <div class="new-field-section">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 14px;">{{ form.new_author.label }}</label>
                {{ form.new_author }}
            </div>
            {% if form.author.errors %}
                <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                    {% for error in form.author.errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.publisher.label }}</label>
            {{ form.publisher }}
            <div class="new-field-section">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 14px;">{{ form.new_publisher.label }}</label>
                {{ form.new_publisher }}
            </div>
            {% if form.publisher.errors %}
                <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                    {% for error in form.publisher.errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <div style="margin: 20px 0; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.description.label }}</label>
        {{ form.description }}
        {% if form.description.errors %}
            <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                {% for error in form.description.errors %}
                    {{ error }}<br>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <div style="display: flex; gap: 20px; margin: 20px 0;">
        <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.price.label }}</label>
            {{ form.price }}
            {% if form.price.errors %}
                <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                    {% for error in form.price.errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.pages.label }}</label>
            {{ form.pages }}
            {% if form.pages.errors %}
                <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                    {% for error in form.pages.errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin: 20px 0;">
        <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.quantity.label }}</label>
            {{ form.quantity }}
            {% if form.quantity.errors %}
                <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                    {% for error in form.quantity.errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div style="flex: 1; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.publication_date.label }}</label>
            {{ form.publication_date }}
            {% if form.publication_date.errors %}
                <div style="color: #dc3545; font-size: 14px; margin-top: 5px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                    {% for error in form.publication_date.errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <div style="margin: 20px 0; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.genre.label }}</label>
        <p style="color: #6c757d; font-size: 14px; margin-bottom: 15px; font-style: italic;">💡 می‌توانید ژانرهای موجود را انتخاب کنید یا ژانر جدیدی اضافه کنید. ژانرهای جدید به صورت خودکار انتخاب می‌شوند.</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
            {% for choice in form.genre %}
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                    {{ choice.tag }}
                    <label for="{{ choice.id_for_label }}" style="margin: 0; cursor: pointer; font-size: 14px; color: #495057;">{{ choice.choice_label }}</label>
                </div>
            {% endfor %}
        </div>
        <div class="new-field-section">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 14px;">{{ form.new_genre.label }}</label>
            {{ form.new_genre }}
        </div>
        {% if form.genre.errors %}
            <div style="color: #dc3545; font-size: 14px; margin-top: 10px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                {% for error in form.genre.errors %}
                    {{ error }}<br>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <div style="margin: 20px 0; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #495057; font-size: 16px;">{{ form.image.label }}</label>
        {{ form.image }}
        {% if form.image.errors %}
            <div style="color: #dc3545; font-size: 14px; margin-top: 10px; background: #f8d7da; padding: 8px; border-radius: 4px;">
                {% for error in form.image.errors %}
                    {{ error }}<br>
                {% endfor %}
            </div>
        {% endif %}
        
        {% if book and book.image %}
            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                <p style="margin: 0 0 15px 0; font-weight: bold; color: #495057;">تصویر فعلی:</p>
                <img src="{{ book.image.url }}" alt="{{ book.title }}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display: none; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                    ⚠️ خطا در بارگذاری تصویر. لطفاً تصویر جدیدی آپلود کنید.
                </div>
            </div>
        {% endif %}
    </div>

    <div style="margin: 40px 0; text-align: center; background: white; padding: 30px; border-radius: 8px; border: 1px solid #e9ecef;">
        <button type="submit" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px 40px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin: 0 15px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); transition: all 0.3s ease;">
            💾 ذخیره کتاب
        </button>
        <a href="{% url 'core:book_management' %}" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-size: 16px; font-weight: bold; margin: 0 15px; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3); transition: all 0.3s ease; display: inline-block;">
            ← بازگشت به لیست
        </a>
    </div>
</form>

{% endblock %}
